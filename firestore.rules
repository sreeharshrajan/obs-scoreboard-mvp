rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ==========================
       COMMON HELPERS
    ========================== */

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated()
        && request.auth.token.role == "admin";
    }

    function isOwner(field) {
      return isAuthenticated()
        && resource.data[field] == request.auth.uid;
    }

    function isCreatingSelf(field) {
      return isAuthenticated()
        && request.resource.data[field] == request.auth.uid;
    }

    // 1. PUBLIC READ FOR OVERLAY (Collection Group Rule)
    // This MUST be at the top level and explicitly allow read for the 'matches' collection group
    match /{path=**}/matches/{matchId} {
      allow read: if true;
    }

    /* ==========================
       USERS
       - Users can read their profile
       - Only admin can write
    ========================== */

    match /users/{userId} {
      allow read: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
      allow create, update, delete: if isAdmin();
    }

    /* ==========================
       TOURNAMENTS
       - Admin: full access
       - User: owner-only
       - OwnerId immutable
    ========================== */

    match /tournaments/{tournamentId} {
      allow read: if isAuthenticated() && (isAdmin() || isOwner("ownerId"));
      allow create: if isAuthenticated() && isCreatingSelf("ownerId");
      allow update: if isAuthenticated() && (isAdmin() || isOwner("ownerId"))
                    && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isAdmin();

      // Sub-collection rule (for direct path access)
      match /matches/{matchId} {
        allow read: if true; 
        allow write: if isAdmin() || isOwner("ownerId");
      }
    }

    /* ==========================
       MATCH METADATA (IMMUTABLE)
       - Firestore stores config only
       - No live score updates here
    ========================== */

    match /matches/{matchId} {

      allow read: if isAuthenticated();

      allow create: if isAuthenticated()
        && isCreatingSelf("createdBy");

      allow update, delete: if isAdmin();
    }

    // 3. GLOBAL FALLBACK (Keep this at the bottom)
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
